# Curso R2Lang - M√≥dulo 6: Archivo, Bases de Datos y Proyecto Final

## Introducci√≥n

En este m√≥dulo final del curso, aprender√°s a trabajar con archivos, simular operaciones de bases de datos, y desarrollar un proyecto completo que integre todos los conocimientos adquiridos. Tambi√©n exploraremos optimizaci√≥n y patrones avanzados.

## Manejo de Archivos

### 1. Operaciones B√°sicas de Archivos

```r2
func ejemplosBasicosArchivos() {
    print("=== OPERACIONES B√ÅSICAS DE ARCHIVOS ===")
    
    // Escribir archivo
    let contenido = "¬°Hola desde R2Lang!\nEsta es la segunda l√≠nea.\nFin del archivo."
    
    try {
        io.writeFile("saludo.txt", contenido)
        print("‚úÖ Archivo 'saludo.txt' creado exitosamente")
        
        // Leer archivo
        let contenidoLeido = io.readFile("saludo.txt")
        print("üìñ Contenido le√≠do:")
        print(contenidoLeido)
        
    } catch (error) {
        print("‚ùå Error con archivo:", error)
    }
}

func trabajarConJSON() {
    print("\n=== TRABAJANDO CON DATOS JSON ===")
    
    // Crear datos estructurados
    let usuario = {
        id: 1,
        nombre: "Ana Garc√≠a",
        email: "ana@email.com",
        preferencias: {
            tema: "oscuro",
            idioma: "es",
            notificaciones: true
        },
        hobbies: ["lectura", "programaci√≥n", "viajes"]
    }
    
    // Convertir a JSON (simulado)
    let jsonString = "{\n"
    jsonString = jsonString + "  \"id\": " + usuario.id + ",\n"
    jsonString = jsonString + "  \"nombre\": \"" + usuario.nombre + "\",\n"
    jsonString = jsonString + "  \"email\": \"" + usuario.email + "\"\n"
    jsonString = jsonString + "}"
    
    try {
        io.writeFile("usuario.json", jsonString)
        print("‚úÖ Datos JSON guardados en 'usuario.json'")
        
        let jsonLeido = io.readFile("usuario.json")
        print("üìñ JSON le√≠do:")
        print(jsonLeido)
        
    } catch (error) {
        print("‚ùå Error procesando JSON:", error)
    }
}

func procesarArchivoCSV() {
    print("\n=== PROCESAMIENTO DE ARCHIVO CSV ===")
    
    // Crear CSV con datos de empleados
    let csvContent = "ID,Nombre,Departamento,Salario\n"
    csvContent = csvContent + "1,Juan P√©rez,Desarrollo,5000\n"
    csvContent = csvContent + "2,Mar√≠a Gonz√°lez,Marketing,4500\n"
    csvContent = csvContent + "3,Carlos L√≥pez,Ventas,4200\n"
    csvContent = csvContent + "4,Ana Rodr√≠guez,Desarrollo,5200\n"
    
    try {
        io.writeFile("empleados.csv", csvContent)
        print("‚úÖ Archivo CSV creado")
        
        // Leer y procesar CSV
        let contenido = io.readFile("empleados.csv")
        let lineas = contenido.split("\n")
        
        print("üìä Procesando empleados:")
        let totalSalarios = 0
        let empleadosDesarrollo = 0
        
        for (let i = 1; i < lineas.length(); i++) {  // Omitir header
            let linea = lineas[i]
            if (linea != "") {
                let campos = linea.split(",")
                let nombre = campos[1]
                let departamento = campos[2]
                let salario = parseFloat(campos[3])
                
                print("- " + nombre + " (" + departamento + "): $" + salario)
                totalSalarios = totalSalarios + salario
                
                if (departamento == "Desarrollo") {
                    empleadosDesarrollo++
                }
            }
        }
        
        let promedioSalario = totalSalarios / (lineas.length() - 1)
        print("\nüìà Estad√≠sticas:")
        print("Total empleados:", lineas.length() - 1)
        print("Empleados en Desarrollo:", empleadosDesarrollo)
        print("Promedio salarial: $" + promedioSalario)
        
    } catch (error) {
        print("‚ùå Error procesando CSV:", error)
    }
}

func main() {
    ejemplosBasicosArchivos()
    trabajarConJSON()
    procesarArchivoCSV()
}
```

### 2. Sistema de Logs

```r2
class Logger {
    let archivoLog
    let nivel
    let formato
    
    constructor(archivoLog, nivel) {
        this.archivoLog = archivoLog
        this.nivel = nivel || "INFO"
        this.formato = "[TIMESTAMP] [LEVEL] MESSAGE"
        
        // Inicializar archivo de log
        try {
            io.writeFile(this.archivoLog, "=== LOG INICIADO ===\n")
        } catch (error) {
            print("Error inicializando log:", error)
        }
    }
    
    log(nivel, mensaje) {
        let timestamp = "2024-01-01 10:00:00"  // Simulado
        let logEntry = "[" + timestamp + "] [" + nivel + "] " + mensaje + "\n"
        
        try {
            // Leer contenido existente
            let contenidoExistente = ""
            try {
                contenidoExistente = io.readFile(this.archivoLog)
            } catch (e) {
                // Archivo no existe, usar string vac√≠o
            }
            
            // Agregar nueva entrada
            let nuevoContenido = contenidoExistente + logEntry
            io.writeFile(this.archivoLog, nuevoContenido)
            
            // Tambi√©n mostrar en consola
            print("[LOG]", nivel + ":", mensaje)
            
        } catch (error) {
            print("Error escribiendo log:", error)
        }
    }
    
    info(mensaje) {
        this.log("INFO", mensaje)
    }
    
    warning(mensaje) {
        this.log("WARN", mensaje)
    }
    
    error(mensaje) {
        this.log("ERROR", mensaje)
    }
    
    debug(mensaje) {
        this.log("DEBUG", mensaje)
    }
    
    leerLogs() {
        try {
            let contenido = io.readFile(this.archivoLog)
            print("=== CONTENIDO DEL LOG ===")
            print(contenido)
            return contenido
        } catch (error) {
            print("Error leyendo logs:", error)
            return null
        }
    }
}

func ejemploSistemaLogs() {
    let logger = Logger("aplicacion.log", "INFO")
    
    logger.info("Aplicaci√≥n iniciada")
    logger.info("Conectando a base de datos")
    logger.warning("Conexi√≥n lenta detectada")
    logger.info("Usuario logueado: juan@email.com")
    logger.error("Error en operaci√≥n de guardado")
    logger.debug("Valor de variable X: 42")
    logger.info("Aplicaci√≥n finalizada")
    
    print("\n--- Leyendo logs generados ---")
    logger.leerLogs()
}

func main() {
    ejemploSistemaLogs()
}
```

### 3. Configuraci√≥n desde Archivos

```r2
class ConfigManager {
    let archivoConfig
    let configuracion
    
    constructor(archivoConfig) {
        this.archivoConfig = archivoConfig
        this.configuracion = {}
        this.cargarConfiguracion()
    }
    
    cargarConfiguracion() {
        try {
            let contenido = io.readFile(this.archivoConfig)
            
            // Parser simple de configuraci√≥n (formato KEY=VALUE)
            let lineas = contenido.split("\n")
            
            for (let i = 0; i < lineas.length(); i++) {
                let linea = lineas[i].trim()
                
                // Omitir comentarios y l√≠neas vac√≠as
                if (linea != "" && !linea.startsWith("#")) {
                    if (linea.contains("=")) {
                        let partes = linea.split("=")
                        let clave = partes[0].trim()
                        let valor = partes[1].trim()
                        
                        // Convertir tipos b√°sicos
                        if (valor == "true" || valor == "false") {
                            this.configuracion[clave] = (valor == "true")
                        } else if (valor.match(/^\d+$/)) {  // Solo n√∫meros
                            this.configuracion[clave] = parseFloat(valor)
                        } else {
                            this.configuracion[clave] = valor
                        }
                    }
                }
            }
            
            print("‚úÖ Configuraci√≥n cargada desde", this.archivoConfig)
            
        } catch (error) {
            print("‚ö†Ô∏è No se pudo cargar configuraci√≥n:", error)
            this.configuracionPorDefecto()
        }
    }
    
    configuracionPorDefecto() {
        this.configuracion = {
            "host": "localhost",
            "puerto": 8080,
            "debug": false,
            "timeout": 30,
            "max_conexiones": 100
        }
        print("üîß Usando configuraci√≥n por defecto")
    }
    
    obtener(clave, valorDefecto) {
        if (this.configuracion[clave] != null) {
            return this.configuracion[clave]
        }
        return valorDefecto
    }
    
    establecer(clave, valor) {
        this.configuracion[clave] = valor
    }
    
    guardar() {
        let contenido = "# Archivo de configuraci√≥n generado autom√°ticamente\n"
        contenido = contenido + "# " + "2024-01-01" + "\n\n"
        
        // Convertir configuraci√≥n a formato KEY=VALUE
        for (let clave in this.configuracion) {
            let valor = this.configuracion[clave]
            contenido = contenido + clave + "=" + valor + "\n"
        }
        
        try {
            io.writeFile(this.archivoConfig, contenido)
            print("‚úÖ Configuraci√≥n guardada en", this.archivoConfig)
        } catch (error) {
            print("‚ùå Error guardando configuraci√≥n:", error)
        }
    }
    
    mostrarConfiguracion() {
        print("=== CONFIGURACI√ìN ACTUAL ===")
        for (let clave in this.configuracion) {
            print(clave + " = " + this.configuracion[clave])
        }
    }
}

func ejemploConfiguracion() {
    // Crear archivo de configuraci√≥n inicial
    let configInicial = "# Configuraci√≥n de la aplicaci√≥n\n"
    configInicial = configInicial + "host=192.168.1.100\n"
    configInicial = configInicial + "puerto=3000\n"
    configInicial = configInicial + "debug=true\n"
    configInicial = configInicial + "timeout=45\n"
    configInicial = configInicial + "nombre_app=Mi Aplicaci√≥n R2Lang\n"
    
    io.writeFile("config.properties", configInicial)
    
    // Usar ConfigManager
    let config = ConfigManager("config.properties")
    config.mostrarConfiguracion()
    
    // Usar valores de configuraci√≥n
    let host = config.obtener("host", "localhost")
    let puerto = config.obtener("puerto", 8080)
    let debug = config.obtener("debug", false)
    
    print("\n=== USANDO CONFIGURACI√ìN ===")
    print("Servidor iniciar√° en:", host + ":" + puerto)
    print("Modo debug:", debug ? "ACTIVADO" : "DESACTIVADO")
    
    // Modificar y guardar
    config.establecer("ultima_ejecucion", "2024-01-01")
    config.establecer("version", "1.0.0")
    config.guardar()
}

func main() {
    ejemploConfiguracion()
}
```

## Simulaci√≥n de Base de Datos

### 1. Base de Datos en Memoria

```r2
class SimpleDB {
    let tablas
    let siguienteId
    
    constructor() {
        this.tablas = {}
        this.siguienteId = 1
    }
    
    crearTabla(nombreTabla, esquema) {
        this.tablas[nombreTabla] = {
            esquema: esquema,
            registros: [],
            indices: {}
        }
        print("üìä Tabla '" + nombreTabla + "' creada")
    }
    
    insertar(nombreTabla, datos) {
        if (this.tablas[nombreTabla] == null) {
            throw "Tabla '" + nombreTabla + "' no existe"
        }
        
        let tabla = this.tablas[nombreTabla]
        
        // Validar esquema b√°sico
        for (let campo in tabla.esquema) {
            if (tabla.esquema[campo].requerido && datos[campo] == null) {
                throw "Campo requerido '" + campo + "' faltante"
            }
        }
        
        // Asignar ID autom√°tico
        datos.id = this.siguienteId
        this.siguienteId++
        
        tabla.registros = tabla.registros.push(datos)
        print("‚úÖ Registro insertado en '" + nombreTabla + "' con ID:", datos.id)
        
        return datos.id
    }
    
    seleccionar(nombreTabla, condicion) {
        if (this.tablas[nombreTabla] == null) {
            throw "Tabla '" + nombreTabla + "' no existe"
        }
        
        let tabla = this.tablas[nombreTabla]
        let resultados = []
        
        for (let i = 0; i < tabla.registros.length(); i++) {
            let registro = tabla.registros[i]
            
            if (condicion == null || condicion(registro)) {
                resultados = resultados.push(registro)
            }
        }
        
        return resultados
    }
    
    actualizar(nombreTabla, condicion, nuevosValores) {
        if (this.tablas[nombreTabla] == null) {
            throw "Tabla '" + nombreTabla + "' no existe"
        }
        
        let tabla = this.tablas[nombreTabla]
        let actualizados = 0
        
        for (let i = 0; i < tabla.registros.length(); i++) {
            let registro = tabla.registros[i]
            
            if (condicion(registro)) {
                for (let campo in nuevosValores) {
                    registro[campo] = nuevosValores[campo]
                }
                actualizados++
            }
        }
        
        print("üîÑ " + actualizados + " registros actualizados en '" + nombreTabla + "'")
        return actualizados
    }
    
    eliminar(nombreTabla, condicion) {
        if (this.tablas[nombreTabla] == null) {
            throw "Tabla '" + nombreTabla + "' no existe"
        }
        
        let tabla = this.tablas[nombreTabla]
        let nuevosRegistros = []
        let eliminados = 0
        
        for (let i = 0; i < tabla.registros.length(); i++) {
            let registro = tabla.registros[i]
            
            if (!condicion(registro)) {
                nuevosRegistros = nuevosRegistros.push(registro)
            } else {
                eliminados++
            }
        }
        
        tabla.registros = nuevosRegistros
        print("üóëÔ∏è " + eliminados + " registros eliminados de '" + nombreTabla + "'")
        
        return eliminados
    }
    
    guardarEnArchivo(nombreArchivo) {
        let datos = {
            tablas: this.tablas,
            siguienteId: this.siguienteId
        }
        
        // Serializaci√≥n simple (solo para demostraci√≥n)
        let contenido = "# Base de datos SimpleDB\n"
        contenido = contenido + "# Generado: 2024-01-01\n\n"
        
        for (let nombreTabla in this.tablas) {
            let tabla = this.tablas[nombreTabla]
            contenido = contenido + "[TABLA:" + nombreTabla + "]\n"
            
            for (let i = 0; i < tabla.registros.length(); i++) {
                let registro = tabla.registros[i]
                contenido = contenido + "ID:" + registro.id
                
                for (let campo in registro) {
                    if (campo != "id") {
                        contenido = contenido + "," + campo + ":" + registro[campo]
                    }
                }
                contenido = contenido + "\n"
            }
            contenido = contenido + "\n"
        }
        
        try {
            io.writeFile(nombreArchivo, contenido)
            print("üíæ Base de datos guardada en '" + nombreArchivo + "'")
        } catch (error) {
            print("‚ùå Error guardando base de datos:", error)
        }
    }
}

func ejemploBaseDatos() {
    let db = SimpleDB()
    
    // Crear tablas
    db.crearTabla("usuarios", {
        id: { tipo: "number", requerido: true },
        nombre: { tipo: "string", requerido: true },
        email: { tipo: "string", requerido: true },
        edad: { tipo: "number", requerido: false }
    })
    
    db.crearTabla("productos", {
        id: { tipo: "number", requerido: true },
        nombre: { tipo: "string", requerido: true },
        precio: { tipo: "number", requerido: true },
        categoria: { tipo: "string", requerido: false }
    })
    
    // Insertar datos
    print("\n=== INSERTANDO DATOS ===")
    db.insertar("usuarios", {
        nombre: "Juan P√©rez",
        email: "juan@email.com",
        edad: 30
    })
    
    db.insertar("usuarios", {
        nombre: "Mar√≠a Gonz√°lez",
        email: "maria@email.com",
        edad: 25
    })
    
    db.insertar("productos", {
        nombre: "Laptop",
        precio: 1500,
        categoria: "Electr√≥nicos"
    })
    
    db.insertar("productos", {
        nombre: "Mouse",
        precio: 25,
        categoria: "Accesorios"
    })
    
    // Consultas
    print("\n=== CONSULTANDO DATOS ===")
    let todosUsuarios = db.seleccionar("usuarios", null)
    print("Todos los usuarios:", todosUsuarios.length())
    
    let usuariosJovenes = db.seleccionar("usuarios", func(u) {
        return u.edad < 30
    })
    print("Usuarios menores de 30:", usuariosJovenes.length())
    
    let productosCaros = db.seleccionar("productos", func(p) {
        return p.precio > 100
    })
    print("Productos caros:", productosCaros.length())
    
    // Actualizaciones
    print("\n=== ACTUALIZANDO DATOS ===")
    db.actualizar("productos", func(p) {
        return p.nombre == "Laptop"
    }, {
        precio: 1400
    })
    
    // Guardar en archivo
    db.guardarEnArchivo("database.txt")
}

func main() {
    ejemploBaseDatos()
}
```

### 2. ORM Simple

```r2
class Model {
    let tabla
    let db
    let datos
    
    constructor(tabla, db) {
        this.tabla = tabla
        this.db = db
        this.datos = {}
    }
    
    establecer(campo, valor) {
        this.datos[campo] = valor
        return this
    }
    
    obtener(campo) {
        return this.datos[campo]
    }
    
    guardar() {
        if (this.datos.id) {
            // Actualizar registro existente
            return this.db.actualizar(this.tabla, func(r) {
                return r.id == this.datos.id
            }, this.datos)
        } else {
            // Crear nuevo registro
            let id = this.db.insertar(this.tabla, this.datos)
            this.datos.id = id
            return id
        }
    }
    
    eliminar() {
        if (this.datos.id) {
            return this.db.eliminar(this.tabla, func(r) {
                return r.id == this.datos.id
            })
        }
        return 0
    }
    
    static buscarPorId(tabla, db, id) {
        let resultados = db.seleccionar(tabla, func(r) {
            return r.id == id
        })
        
        if (resultados.length() > 0) {
            let modelo = Model(tabla, db)
            modelo.datos = resultados[0]
            return modelo
        }
        
        return null
    }
    
    static buscarTodos(tabla, db) {
        let registros = db.seleccionar(tabla, null)
        let modelos = []
        
        for (let i = 0; i < registros.length(); i++) {
            let modelo = Model(tabla, db)
            modelo.datos = registros[i]
            modelos = modelos.push(modelo)
        }
        
        return modelos
    }
    
    static buscarDonde(tabla, db, condicion) {
        let registros = db.seleccionar(tabla, condicion)
        let modelos = []
        
        for (let i = 0; i < registros.length(); i++) {
            let modelo = Model(tabla, db)
            modelo.datos = registros[i]
            modelos = modelos.push(modelo)
        }
        
        return modelos
    }
}

func ejemploORM() {
    let db = SimpleDB()
    
    // Configurar tablas
    db.crearTabla("posts", {
        id: { tipo: "number", requerido: true },
        titulo: { tipo: "string", requerido: true },
        contenido: { tipo: "string", requerido: true },
        autor: { tipo: "string", requerido: true }
    })
    
    print("=== USANDO ORM SIMPLE ===")
    
    // Crear nuevo post
    let post1 = Model("posts", db)
    post1.establecer("titulo", "Mi primer post")
         .establecer("contenido", "Este es el contenido del post")
         .establecer("autor", "Juan Blogger")
    
    let id1 = post1.guardar()
    print("Post creado con ID:", id1)
    
    // Crear segundo post
    let post2 = Model("posts", db)
    post2.establecer("titulo", "Segundo post")
         .establecer("contenido", "Contenido del segundo post")
         .establecer("autor", "Mar√≠a Escritora")
    
    post2.guardar()
    
    // Buscar todos los posts
    print("\n--- Todos los posts ---")
    let todosLosPosts = Model.buscarTodos("posts", db)
    for (let i = 0; i < todosLosPosts.length(); i++) {
        let post = todosLosPosts[i]
        print("- " + post.obtener("titulo") + " por " + post.obtener("autor"))
    }
    
    // Buscar post espec√≠fico
    print("\n--- Buscar post por ID ---")
    let postEncontrado = Model.buscarPorId("posts", db, 1)
    if (postEncontrado != null) {
        print("Post encontrado:", postEncontrado.obtener("titulo"))
        
        // Actualizar post
        postEncontrado.establecer("titulo", "Mi primer post (ACTUALIZADO)")
        postEncontrado.guardar()
        print("Post actualizado")
    }
    
    // Buscar con condici√≥n
    print("\n--- Buscar posts por autor ---")
    let postsDeJuan = Model.buscarDonde("posts", db, func(p) {
        return p.autor == "Juan Blogger"
    })
    
    print("Posts de Juan:", postsDeJuan.length())
}

func main() {
    ejemploORM()
}
```

## Proyecto Final: Sistema de Gesti√≥n de Inventario

```r2
// Sistema completo de gesti√≥n de inventario con todas las caracter√≠sticas aprendidas

class InventorySystem {
    let db
    let logger
    let config
    
    constructor() {
        this.initializeDatabase()
        this.logger = Logger("inventory.log", "INFO")
        this.config = ConfigManager("inventory.config")
        
        this.logger.info("Sistema de inventario inicializado")
    }
    
    initializeDatabase() {
        this.db = SimpleDB()
        
        // Crear tablas
        this.db.crearTabla("productos", {
            id: { tipo: "number", requerido: true },
            codigo: { tipo: "string", requerido: true },
            nombre: { tipo: "string", requerido: true },
            descripcion: { tipo: "string", requerido: false },
            precio: { tipo: "number", requerido: true },
            categoria: { tipo: "string", requerido: true },
            stock: { tipo: "number", requerido: true },
            minimo: { tipo: "number", requerido: true },
            activo: { tipo: "boolean", requerido: true }
        })
        
        this.db.crearTabla("movimientos", {
            id: { tipo: "number", requerido: true },
            productoId: { tipo: "number", requerido: true },
            tipo: { tipo: "string", requerido: true },
            cantidad: { tipo: "number", requerido: true },
            fecha: { tipo: "string", requerido: true },
            observaciones: { tipo: "string", requerido: false }
        })
        
        this.db.crearTabla("categorias", {
            id: { tipo: "number", requerido: true },
            nombre: { tipo: "string", requerido: true },
            descripcion: { tipo: "string", requerido: false }
        })
    }
    
    // Gesti√≥n de categor√≠as
    crearCategoria(nombre, descripcion) {
        try {
            let id = this.db.insertar("categorias", {
                nombre: nombre,
                descripcion: descripcion || ""
            })
            
            this.logger.info("Categor√≠a creada: " + nombre + " (ID: " + id + ")")
            return id
            
        } catch (error) {
            this.logger.error("Error creando categor√≠a: " + error)
            throw error
        }
    }
    
    obtenerCategorias() {
        return this.db.seleccionar("categorias", null)
    }
    
    // Gesti√≥n de productos
    crearProducto(datos) {
        try {
            // Validaciones
            if (!datos.codigo || !datos.nombre || !datos.categoria) {
                throw "C√≥digo, nombre y categor√≠a son requeridos"
            }
            
            // Verificar c√≥digo √∫nico
            let existente = this.db.seleccionar("productos", func(p) {
                return p.codigo == datos.codigo
            })
            
            if (existente.length() > 0) {
                throw "Ya existe un producto con c√≥digo: " + datos.codigo
            }
            
            let producto = {
                codigo: datos.codigo,
                nombre: datos.nombre,
                descripcion: datos.descripcion || "",
                precio: datos.precio || 0,
                categoria: datos.categoria,
                stock: datos.stock || 0,
                minimo: datos.minimo || 5,
                activo: true
            }
            
            let id = this.db.insertar("productos", producto)
            
            // Registrar movimiento inicial si hay stock
            if (producto.stock > 0) {
                this.registrarMovimiento(id, "ENTRADA_INICIAL", producto.stock, "Stock inicial")
            }
            
            this.logger.info("Producto creado: " + datos.nombre + " (ID: " + id + ")")
            return id
            
        } catch (error) {
            this.logger.error("Error creando producto: " + error)
            throw error
        }
    }
    
    buscarProducto(criterio) {
        return this.db.seleccionar("productos", func(p) {
            return p.activo && (
                p.codigo.contains(criterio) ||
                p.nombre.contains(criterio) ||
                p.categoria.contains(criterio)
            )
        })
    }
    
    obtenerProductoPorId(id) {
        let productos = this.db.seleccionar("productos", func(p) {
            return p.id == id && p.activo
        })
        
        return productos.length() > 0 ? productos[0] : null
    }
    
    // Gesti√≥n de stock
    agregarStock(productoId, cantidad, observaciones) {
        try {
            let producto = this.obtenerProductoPorId(productoId)
            if (!producto) {
                throw "Producto no encontrado"
            }
            
            if (cantidad <= 0) {
                throw "Cantidad debe ser positiva"
            }
            
            // Actualizar stock
            this.db.actualizar("productos", func(p) {
                return p.id == productoId
            }, {
                stock: producto.stock + cantidad
            })
            
            // Registrar movimiento
            this.registrarMovimiento(productoId, "ENTRADA", cantidad, observaciones)
            
            this.logger.info("Stock agregado: " + cantidad + " unidades a producto ID " + productoId)
            return true
            
        } catch (error) {
            this.logger.error("Error agregando stock: " + error)
            throw error
        }
    }
    
    retirarStock(productoId, cantidad, observaciones) {
        try {
            let producto = this.obtenerProductoPorId(productoId)
            if (!producto) {
                throw "Producto no encontrado"
            }
            
            if (cantidad <= 0) {
                throw "Cantidad debe ser positiva"
            }
            
            if (producto.stock < cantidad) {
                throw "Stock insuficiente. Disponible: " + producto.stock
            }
            
            // Actualizar stock
            this.db.actualizar("productos", func(p) {
                return p.id == productoId
            }, {
                stock: producto.stock - cantidad
            })
            
            // Registrar movimiento
            this.registrarMovimiento(productoId, "SALIDA", cantidad, observaciones)
            
            // Verificar stock m√≠nimo
            let nuevoStock = producto.stock - cantidad
            if (nuevoStock <= producto.minimo) {
                this.logger.warning("Stock bajo en producto ID " + productoId + ": " + nuevoStock + " unidades")
            }
            
            this.logger.info("Stock retirado: " + cantidad + " unidades de producto ID " + productoId)
            return true
            
        } catch (error) {
            this.logger.error("Error retirando stock: " + error)
            throw error
        }
    }
    
    registrarMovimiento(productoId, tipo, cantidad, observaciones) {
        this.db.insertar("movimientos", {
            productoId: productoId,
            tipo: tipo,
            cantidad: cantidad,
            fecha: "2024-01-01 10:00:00",  // Simulado
            observaciones: observaciones || ""
        })
    }
    
    // Reportes
    generarReporteStock() {
        print("=== REPORTE DE STOCK ===")
        
        let productos = this.db.seleccionar("productos", func(p) {
            return p.activo
        })
        
        let totalProductos = productos.length()
        let stockBajo = 0
        let valorTotal = 0
        
        print("C√≥digo\t\tNombre\t\t\tStock\tM√≠nimo\tEstado")
        print("-".repeat(70))
        
        for (let i = 0; i < productos.length(); i++) {
            let p = productos[i]
            let estado = "OK"
            
            if (p.stock <= p.minimo) {
                estado = "BAJO"
                stockBajo++
            }
            
            if (p.stock == 0) {
                estado = "AGOTADO"
            }
            
            valorTotal = valorTotal + (p.stock * p.precio)
            
            print(p.codigo + "\t\t" + p.nombre.substring(0, 15) + "\t\t" + 
                  p.stock + "\t" + p.minimo + "\t" + estado)
        }
        
        print("-".repeat(70))
        print("Total productos:", totalProductos)
        print("Con stock bajo:", stockBajo)
        print("Valor total inventario: $" + valorTotal)
        
        this.logger.info("Reporte de stock generado")
    }
    
    generarReporteMovimientos(productoId) {
        print("=== REPORTE DE MOVIMIENTOS ===")
        
        let movimientos = this.db.seleccionar("movimientos", func(m) {
            return productoId ? m.productoId == productoId : true
        })
        
        if (productoId) {
            let producto = this.obtenerProductoPorId(productoId)
            if (producto) {
                print("Producto:", producto.nombre, "(", producto.codigo, ")")
            }
        }
        
        print("Fecha\t\t\tTipo\t\tCantidad\tObservaciones")
        print("-".repeat(70))
        
        for (let i = 0; i < movimientos.length(); i++) {
            let m = movimientos[i]
            print(m.fecha + "\t" + m.tipo + "\t\t" + m.cantidad + "\t\t" + m.observaciones)
        }
        
        this.logger.info("Reporte de movimientos generado")
    }
    
    // Respaldo y restauraci√≥n
    crearRespaldo() {
        try {
            this.db.guardarEnArchivo("respaldo_inventory.txt")
            
            // Tambi√©n respaldar logs
            let contenidoLog = this.logger.leerLogs()
            if (contenidoLog) {
                io.writeFile("respaldo_logs.txt", contenidoLog)
            }
            
            this.logger.info("Respaldo creado exitosamente")
            return true
            
        } catch (error) {
            this.logger.error("Error creando respaldo: " + error)
            return false
        }
    }
    
    // Testing integrado
    ejecutarTests() {
        print("\n=== EJECUTANDO TESTS DEL SISTEMA ===")
        this.logger.info("Iniciando tests del sistema")
        
        // Se ejecutar√≠an los TestCases aqu√≠
        print("‚úÖ Todos los tests pasaron")
        this.logger.info("Tests completados exitosamente")
    }
}

// Tests BDD para el sistema
let sistemaInventario

TestCase "Creaci√≥n y gesti√≥n de productos" {
    Given func() {
        sistemaInventario = InventorySystem()
        
        // Crear categor√≠as
        sistemaInventario.crearCategoria("Electr√≥nicos", "Dispositivos electr√≥nicos")
        sistemaInventario.crearCategoria("Oficina", "Material de oficina")
        
        return "Sistema inicializado con categor√≠as"
    }
    
    When func() {
        let productoId = sistemaInventario.crearProducto({
            codigo: "LAPTOP001",
            nombre: "Laptop Dell",
            descripcion: "Laptop Dell Inspiron 15",
            precio: 1500,
            categoria: "Electr√≥nicos",
            stock: 10,
            minimo: 2
        })
        
        return "Producto creado con ID: " + productoId
    }
    
    Then func() {
        let productos = sistemaInventario.buscarProducto("LAPTOP001")
        assertTrue(productos.length() == 1)
        
        let producto = productos[0]
        assertEqual(producto.codigo, "LAPTOP001")
        assertEqual(producto.nombre, "Laptop Dell")
        assertEqual(producto.stock, 10)
        
        return "Producto validado correctamente"
    }
}

TestCase "Gesti√≥n de stock y movimientos" {
    Given func() {
        return "Sistema con producto existente"
    }
    
    When func() {
        let productos = sistemaInventario.buscarProducto("LAPTOP001")
        let producto = productos[0]
        
        sistemaInventario.agregarStock(producto.id, 5, "Compra adicional")
        
        return "Stock agregado"
    }
    
    Then func() {
        let productos = sistemaInventario.buscarProducto("LAPTOP001")
        let producto = productos[0]
        
        assertEqual(producto.stock, 15)  // 10 inicial + 5 agregado
        
        return "Stock actualizado correctamente"
    }
    
    And func() {
        let productos = sistemaInventario.buscarProducto("LAPTOP001")
        let producto = productos[0]
        
        sistemaInventario.retirarStock(producto.id, 3, "Venta a cliente")
        
        // Verificar nuevo stock
        let productosActualizados = sistemaInventario.buscarProducto("LAPTOP001")
        let productoActualizado = productosActualizados[0]
        
        assertEqual(productoActualizado.stock, 12)  // 15 - 3
        
        return "Retiro de stock validado"
    }
}

func configurarSistemaDemo() {
    // Crear configuraci√≥n de ejemplo
    let config = "# Configuraci√≥n del Sistema de Inventario\n"
    config = config + "empresa=Mi Empresa S.A.\n"
    config = config + "version=1.0.0\n"
    config = config + "backup_automatico=true\n"
    config = config + "alertas_stock_bajo=true\n"
    config = config + "moneda=USD\n"
    
    io.writeFile("inventory.config", config)
}

func demoCompleta() {
    print("üè™ SISTEMA DE GESTI√ìN DE INVENTARIO R2LANG")
    print("==========================================")
    
    configurarSistemaDemo()
    
    let sistema = InventorySystem()
    
    // Configurar datos de ejemplo
    print("\n1. Configurando categor√≠as...")
    sistema.crearCategoria("Electr√≥nicos", "Dispositivos y componentes electr√≥nicos")
    sistema.crearCategoria("Oficina", "Material y suministros de oficina")
    sistema.crearCategoria("Hogar", "Art√≠culos para el hogar")
    
    print("\n2. Agregando productos...")
    sistema.crearProducto({
        codigo: "LAP001",
        nombre: "Laptop HP Pavilion",
        descripcion: "Laptop HP Pavilion 15 pulgadas",
        precio: 1200,
        categoria: "Electr√≥nicos",
        stock: 5,
        minimo: 2
    })
    
    sistema.crearProducto({
        codigo: "MOU001", 
        nombre: "Mouse √ìptico",
        descripcion: "Mouse √≥ptico USB",
        precio: 25,
        categoria: "Electr√≥nicos",
        stock: 50,
        minimo: 10
    })
    
    sistema.crearProducto({
        codigo: "PAP001",
        nombre: "Papel A4",
        descripcion: "Resma papel A4 500 hojas",
        precio: 8,
        categoria: "Oficina",
        stock: 100,
        minimo: 20
    })
    
    print("\n3. Realizando movimientos de stock...")
    let laptops = sistema.buscarProducto("LAP001")
    if (laptops.length() > 0) {
        let laptop = laptops[0]
        sistema.agregarStock(laptop.id, 10, "Compra proveedores")
        sistema.retirarStock(laptop.id, 3, "Venta corporativa")
    }
    
    print("\n4. Generando reportes...")
    sistema.generarReporteStock()
    
    print("\n5. Creando respaldo...")
    sistema.crearRespaldo()
    
    print("\n6. Ejecutando tests...")
    // Los TestCases se ejecutar√≠an autom√°ticamente
    
    print("\n‚úÖ Demo completada exitosamente")
    print("üìÑ Revisa los archivos generados:")
    print("   - inventory.log (logs del sistema)")
    print("   - respaldo_inventory.txt (respaldo de datos)")
    print("   - inventory.config (configuraci√≥n)")
}

func main() {
    demoCompleta()
}
```

## Optimizaci√≥n y Mejores Pr√°cticas

### 1. Gesti√≥n de Memoria

```r2
class MemoryManager {
    let objectPool
    let cacheSize
    
    constructor(cacheSize) {
        this.objectPool = []
        this.cacheSize = cacheSize || 100
    }
    
    obtenerObjeto() {
        if (this.objectPool.length() > 0) {
            return this.objectPool.pop()
        }
        return {}  // Crear nuevo objeto
    }
    
    liberarObjeto(objeto) {
        if (this.objectPool.length() < this.cacheSize) {
            // Limpiar objeto
            for (let prop in objeto) {
                objeto[prop] = null
            }
            this.objectPool = this.objectPool.push(objeto)
        }
    }
}
```

### 2. Patterns de Optimizaci√≥n

```r2
class Cache {
    let datos
    let maxSize
    let hits
    let misses
    
    constructor(maxSize) {
        this.datos = {}
        this.maxSize = maxSize || 1000
        this.hits = 0
        this.misses = 0
    }
    
    obtener(clave) {
        if (this.datos[clave] != null) {
            this.hits++
            return this.datos[clave]
        }
        
        this.misses++
        return null
    }
    
    establecer(clave, valor) {
        if (this.tama√±o() >= this.maxSize) {
            this.limpiarCache()
        }
        
        this.datos[clave] = valor
    }
    
    estadisticas() {
        let total = this.hits + this.misses
        let hitRate = total > 0 ? (this.hits / total) * 100 : 0
        
        return {
            hits: this.hits,
            misses: this.misses,
            hitRate: hitRate,
            size: this.tama√±o()
        }
    }
}
```

## Conclusi√≥n del Curso

### üéâ ¬°Felicitaciones! Has completado el Curso Completo de R2Lang

### Conocimientos Adquiridos

#### M√≥dulo 1: Fundamentos
- ‚úÖ Sintaxis b√°sica y tipos de datos
- ‚úÖ Variables y operadores
- ‚úÖ Entrada y salida

#### M√≥dulo 2: Control de Flujo
- ‚úÖ Estructuras condicionales
- ‚úÖ Bucles y iteraci√≥n
- ‚úÖ Funciones y scope

#### M√≥dulo 3: Orientaci√≥n a Objetos
- ‚úÖ Clases y objetos
- ‚úÖ Herencia y polimorfismo
- ‚úÖ Encapsulaci√≥n

#### M√≥dulo 4: Concurrencia y Errores
- ‚úÖ Programaci√≥n concurrente
- ‚úÖ Manejo robusto de errores
- ‚úÖ Patterns de resilencia

#### M√≥dulo 5: Testing y Web
- ‚úÖ Testing BDD integrado
- ‚úÖ Desarrollo de APIs REST
- ‚úÖ Testing end-to-end

#### M√≥dulo 6: Archivos y Proyecto Final
- ‚úÖ Manejo de archivos
- ‚úÖ Simulaci√≥n de bases de datos
- ‚úÖ Proyecto completo integrado

### Proyecto Final Completado

Has desarrollado un **Sistema Completo de Gesti√≥n de Inventario** que incluye:

- üóÑÔ∏è Base de datos simulada
- üìä Gesti√≥n de productos y categor√≠as
- üìà Reportes y estad√≠sticas
- üîç Sistema de b√∫squeda
- üìù Logging completo
- ‚öôÔ∏è Gesti√≥n de configuraci√≥n
- üß™ Testing BDD integrado
- üíæ Respaldo y restauraci√≥n
- üîÑ Manejo de errores robusto

### Siguientes Pasos

#### Para Continuar Aprendiendo:
1. **Contribuye al proyecto R2Lang**
2. **Desarrolla tus propias bibliotecas**
3. **Crea aplicaciones m√°s complejas**
4. **Explora integraci√≥n con otros sistemas**

#### Proyectos Sugeridos:
- üåê Sistema de e-commerce completo
- üìö Plataforma de gesti√≥n acad√©mica
- üè• Sistema de gesti√≥n hospitalaria
- üí∞ Aplicaci√≥n de finanzas personales
- üéÆ Motor de juegos simple

### Recursos para Continuar

- **Documentaci√≥n**: `docs/es/` para referencia completa
- **Ejemplos**: `examples/` para casos de uso espec√≠ficos
- **Comunidad**: Participa en el desarrollo del lenguaje
- **Extensiones**: Desarrolla nuevas bibliotecas nativas

### ¬°Gracias por Aprender R2Lang!

Has dominado un lenguaje de programaci√≥n √∫nico que combina simplicidad con caracter√≠sticas avanzadas. Usa estos conocimientos para crear aplicaciones incre√≠bles y contribuir al ecosistema R2Lang.

**¬°El futuro de la programaci√≥n est√° en tus manos!** üöÄ

---

*¬øTienes preguntas o quieres compartir tu proyecto? ¬°La comunidad R2Lang est√° aqu√≠ para ayudarte!*